---
- name: "Chercher VLC dans le registre (uninstall)"
  ansible.windows.win_shell: |
    $paths = @(
      'HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*',
      'HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
    )

    $app = Get-ItemProperty -Path $paths -ErrorAction SilentlyContinue |
           Where-Object { $_.DisplayName -like 'VLC media player*' } |
           Select-Object -First 1

    if ($app) {
      $app | Select-Object DisplayName, DisplayVersion, UninstallString, InstallLocation |
        ConvertTo-Json -Compress
    }
  register: vlc_uninstall_raw
  changed_when: false

- name: "Parser les infos VLC si trouvées"
  set_fact:
    vlc_uninstall_info: "{{ vlc_uninstall_raw.stdout | from_json }}"
  when: vlc_uninstall_raw.stdout is defined and (vlc_uninstall_raw.stdout | length > 0)

- name: "VLC non installé : rien à désinstaller"
  set_fact:
    package_status: "unchanged"
    package_message: "VLC non installé, aucune désinstallation nécessaire"
  when: vlc_uninstall_info is not defined
        or (vlc_uninstall_info.UninstallString is not defined)
        or (vlc_uninstall_info.UninstallString | string | length == 0)

- name: "Désinstallation VLC via UninstallString"
  ansible.windows.win_shell: |
	$cmd = '{{ vlc_uninstall_info.UninstallString }}'

	if ($cmd -notmatch '(^|\s)/S(\s|$)') { $cmd = "$cmd /S" }

	# Parse exe + args puis Start-Process
	if ($cmd -match '^\s*"([^"]+)"\s*(.*)$') {
		Start-Process -FilePath $matches[1] -ArgumentList $matches[2] -Wait
	} else {
		$parts = $cmd -split '\s+', 2
		Start-Process -FilePath $parts[0] -ArgumentList ($parts | Select-Object -Skip 1) -Wait
	}
  register: uninstall_out
  when: vlc_uninstall_info is defined
        and (vlc_uninstall_info.UninstallString is defined)
        and (vlc_uninstall_info.UninstallString | string | length > 0)

- name: "Mettre à jour le statut après désinstallation"
  set_fact:
    package_status: "{{ 'removed' if uninstall_out.rc == 0 else 'error' }}"
    package_message: >-
      {{ 'VLC désinstallé'
         if uninstall_out.rc == 0
         else 'Erreur désinstallation VLC (rc=' ~ uninstall_out.rc ~ ')' }}
    reboot_required: false
  when: uninstall_out is defined
