---
# Ici on suppose que detect.yml a déjà tourné
# et posé detect_result.installed = true/false

- name: "VLC non installé : rien à désinstaller"
  set_fact:
    package_status: "unchanged"
    package_message: "VLC non installé, aucune désinstallation nécessaire"
  when: not (detect_result.installed | default(false))

- name: "Vérifier la présence de l'uninstaller VLC"
  ansible.windows.win_stat:
    path: 'C:\Program Files\VideoLAN\VLC\uninstall.exe'
  register: vlc_uninst
  when: detect_result.installed | default(false)

- name: "VLC installé mais pas d'uninstaller trouvé"
  set_fact:
    package_status: "error"
    package_message: "VLC détecté mais C:\\Program Files\\VideoLAN\\VLC\\uninstall.exe introuvable"
  when:
    - detect_result.installed | default(false)
    - not vlc_uninst.stat.exists

- name: "Désinstallation VLC (uninstall.exe /S)"
  ansible.windows.win_shell: >
    & "C:\Program Files\VideoLAN\VLC\uninstall.exe" /S
  register: uninstall_out
  when:
    - detect_result.installed | default(false)
    - vlc_uninst.stat.exists

- name: "Mettre à jour le statut après désinstallation"
  set_fact:
    package_status: "{{ 'removed' if uninstall_out.rc == 0 else 'error' }}"
    package_message: >-
      {{ 'VLC désinstallé'
         if uninstall_out.rc == 0
         else 'Erreur désinstallation VLC (rc=' ~ uninstall_out.rc ~ ')' }}
    reboot_required: false
  when:
    - detect_result.installed | default(false)
    - vlc_uninst.stat.exists

