---
- name: "Chercher VLC dans le registre (uninstall)"
  ansible.windows.win_shell: |
    $paths = @(
      'HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*',
      'HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
    )

    $app = Get-ItemProperty -Path $paths -ErrorAction SilentlyContinue |
           Where-Object { $_.DisplayName -like 'VLC media player*' } |
           Select-Object -First 1

    if ($app) {
      $app | Select-Object DisplayName, DisplayVersion, UninstallString, InstallLocation |
        ConvertTo-Json -Compress
    }
  register: vlc_uninstall_raw
  changed_when: false

- name: "Parser les infos VLC si trouvées"
  set_fact:
    vlc_uninstall_info: "{{ vlc_uninstall_raw.stdout | from_json }}"
  when: vlc_uninstall_raw.stdout is defined and (vlc_uninstall_raw.stdout | length > 0)

- name: "VLC non installé : rien à désinstaller"
  set_fact:
    package_status: "unchanged"
    package_message: "VLC non installé, aucune désinstallation nécessaire"
  when: vlc_uninstall_info is not defined
        or (vlc_uninstall_info.UninstallString | default('') | string | length == 0)

- name: "Désinstallation VLC via UninstallString"
  ansible.windows.win_shell: |
    $cmd = @'
{{ vlc_uninstall_info.UninstallString }}
'@
    # S'assure qu'on a un /S pour silencieux
    if ($cmd -notmatch ' /S( |$)') {
      $cmd = "$cmd /S"
    }

    Start-Process -FilePath "cmd.exe" -ArgumentList "/c $cmd" -Wait -PassThru
  register: uninstall_out
  when: vlc_uninstall_info is defined
        and (vlc_uninstall_info.UninstallString | default('') | string | length > 0)

- name: "Mettre à jour le statut après désinstallation"
  set_fact:
    package_status: "{{ 'removed' if uninstall_out.rc == 0 else 'error' }}"
    package_message: >-
      {{ 'VLC désinstallé'
         if uninstall_out.rc == 0
         else 'Erreur désinstallation VLC (rc=' ~ uninstall_out.rc ~ ')' }}
    reboot_required: false
  when: vlc_uninstall_info is defined
        and (vlc_uninstall_info.UninstallString | default('') | string | length > 0)
