---
# Clean uninstall via registry uninstall string

- name: "Search {{ package_name }} in registry (uninstall)"
  ansible.windows.win_shell: |
    $paths = @(
      'HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*',
      'HKLM:\Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
    )

    $app = Get-ItemProperty -Path $paths -ErrorAction SilentlyContinue |
           Where-Object { $_.DisplayName -like '{{ package_display_name_pattern }}' } |
           Select-Object -First 1

    if ($app) {
      $app | Select-Object DisplayName, DisplayVersion, UninstallString, InstallLocation |
        ConvertTo-Json -Compress
    }
  register: pkg_uninstall_raw
  changed_when: false

- name: "Parse {{ package_name }} uninstall info if found"
  set_fact:
    pkg_uninstall_info: "{{ pkg_uninstall_raw.stdout | from_json }}"
  when: pkg_uninstall_raw.stdout is defined and (pkg_uninstall_raw.stdout | length > 0)

- name: "{{ package_name }} not installed: nothing to uninstall"
  set_fact:
    package_status: "unchanged"
    package_message: "{{ package_name }} not installed, no uninstall needed"
  when: pkg_uninstall_info is not defined
        or (pkg_uninstall_info.UninstallString is not defined)
        or (pkg_uninstall_info.UninstallString | string | length == 0)

- name: "Clean UninstallString (remove outer quotes)"
  set_fact:
    pkg_uninstall_path: "{{ pkg_uninstall_info.UninstallString[1:-1] }}"
  when: pkg_uninstall_info.UninstallString is defined
  
- name: "Debug cleaned uninstall path"
  debug:
    msg: "pkg_uninstall_path='{{ pkg_uninstall_path }}'"
  when: pkg_uninstall_path is defined

- name: "Uninstall {{ package_name }} via UninstallString"
  ansible.windows.win_shell: |
    Write-Output "CMD = '{{ pkg_uninstall_path }} /S'"
    Start-Process -FilePath '{{ pkg_uninstall_path }}' -ArgumentList '/S' -Wait
  args:
    executable: powershell.exe
  register: uninstall_out
  when: pkg_uninstall_path is defined

- name: "Update status after uninstall"
  set_fact:
    package_status: "removed"
    package_message: "{{ package_name }} uninstalled"
    reboot_required: false
  when: uninstall_out is defined
